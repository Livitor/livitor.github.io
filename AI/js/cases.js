/**
 * 本地病虫害案例数据库
 * 包含通用的常见病虫害案例，用于快速识别功能
 * 优化版：提供更丰富、更通用的病虫害信息
 */
class PestCaseDatabase {
    constructor() {
        this.cases = this.initializeCases();
    }

    /**
     * 初始化案例数据库
     */
    initializeCases() {
        return {
            // 通用病害类型 - 不针对特定植物
            '通用病害': {
                '叶斑病': {
                    name: '叶斑病',
                    symptoms: '叶片上出现不规则形状的斑点，颜色可能是褐色、黑色或灰色。斑点可能有黄色晕圈，严重时导致叶片枯萎脱落。',
                    causes: '由多种真菌病原体引起，如链格孢属、交链孢属等。高湿环境和叶片长时间潮湿是主要诱因。',
                    treatment: '1. 喷施广谱性杀菌剂如代森锰锌、百菌清等\n2. 对于严重感染的植株部分进行修剪和销毁\n3. 使用铜制剂如波尔多液进行保护性喷洒\n4. 生物防治可使用枯草芽孢杆菌等微生物制剂',
                    prevention: '1. 保持良好的通风条件\n2. 避免浇水时弄湿叶片\n3. 合理密植，避免植株过密\n4. 定期清除落叶和病残体\n5. 轮作种植，避免连作',
                    notes: '叶斑病是最常见的植物病害之一，几乎影响所有类型的植物。早期发现和处理可有效控制病情蔓延。'
                },
                '白粉病': {
                    name: '白粉病',
                    symptoms: '叶片、茎秆和花朵表面出现白色粉状物质，像撒了一层面粉。随着病情发展，受感染部位可能变黄、变褐，最终枯萎。',
                    causes: '由白粉菌科真菌引起，这类真菌是专性寄生菌。干燥温暖的天气有利于孢子传播，而夜间高湿度有利于孢子萌发。',
                    treatment: '1. 喷施特效杀菌剂如三唑类、硫磺制剂\n2. 使用碳酸氢钾溶液(小苏打)喷洒\n3. 喷施菌油混合物(1份牛奶兑9份水)\n4. 严重时使用系统性杀菌剂如嘧菌酯、戊唑醇等',
                    prevention: '1. 选择抗病品种\n2. 避免过度施用氮肥\n3. 保持适当的植株间距\n4. 避免在白天浇水\n5. 定期检查植株，及早发现病症',
                    notes: '白粉病在早期阶段容易控制，但一旦大面积发生则难以根除。注意药剂交替使用，避免产生抗药性。'
                },
                '炭疽病': {
                    name: '炭疽病',
                    symptoms: '叶片、果实和茎秆上出现圆形或不规则的深褐色至黑色凹陷病斑，病斑中心常有橙色或粉红色的孢子堆。严重时可导致植株死亡。',
                    causes: '由炭疽菌属真菌引起，通过雨水飞溅、灌溉水、昆虫和农具传播。高温高湿环境有利于病害发展。',
                    treatment: '1. 喷施苯醚甲环唑、嘧菌酯等杀菌剂\n2. 铜制剂处理可有效控制早期感染\n3. 生物防治可使用木霉菌、放线菌等拮抗微生物\n4. 及时清除并销毁受感染的植株部分',
                    prevention: '1. 使用健康的种子和种苗\n2. 实行轮作，避免连作\n3. 合理灌溉，避免过湿\n4. 增强植株抗性，适量施用钾肥\n5. 农具使用后进行消毒',
                    notes: '炭疽病是一种毁灭性病害，可在短时间内导致大面积作物损失。预防措施比治疗更为重要。'
                },
                '根腐病': {
                    name: '根腐病',
                    symptoms: '地上部分表现为生长缓慢、叶片黄化、萎蔫，严重时整株死亡。根部变褐、腐烂、失去活力，有时会有恶臭。',
                    causes: '由多种土壤病原体引起，包括镰刀菌、腐霉菌、疫霉菌等。土壤过湿、排水不良和连作是主要诱因。',
                    treatment: '1. 改善土壤排水条件\n2. 使用甲基托布津、福美双等杀菌剂灌根\n3. 生物制剂如哈茨木霉、枯草芽孢杆菌处理土壤\n4. 重症植株需挖除并销毁，避免病原体扩散',
                    prevention: '1. 选择健康种苗\n2. 使用消毒的栽培基质\n3. 避免过度浇水\n4. 实行轮作\n5. 种植前对土壤进行消毒处理\n6. 合理施肥，增强植株抵抗力',
                    notes: '根腐病一旦发生很难彻底治愈，预防工作尤为重要。注意检查新购植株的根系健康状况。'
                },
                '病毒病': {
                    name: '病毒病',
                    symptoms: '叶片出现花叶、皱缩、畸形，植株矮化，花果畸形或减少。叶片可能出现黄色、绿色的花纹或环斑。',
                    causes: '由各种植物病毒引起，主要通过蚜虫、粉虱等昆虫传播，也可通过嫁接、接触和种子传播。',
                    treatment: '1. 病毒病无有效化学治疗方法\n2. 及时清除并销毁受感染植株\n3. 控制传播媒介昆虫，如喷施吡虫啉等杀虫剂\n4. 使用抗病毒制剂如病毒唑、宁南霉素等可减轻症状',
                    prevention: '1. 使用无病毒种苗\n2. 定期消毒农具\n3. 控制媒介昆虫种群\n4. 选择抗病品种\n5. 实行轮作\n6. 保持良好的田间卫生',
                    notes: '病毒病无法彻底治愈，一旦发现应立即隔离并销毁病株。预防工作是控制病毒病的关键。'
                }
            },
            
            // 通用虫害类型 - 不针对特定植物
            '通用虫害': {
                '蚜虫': {
                    name: '蚜虫危害',
                    symptoms: '植株新梢、嫩叶和花蕾聚集大量小型绿色、黑色或红色昆虫。叶片卷曲变形，生长点发育不良。植株表面可能有黏腻的蜜露，并引发煤烟病。',
                    causes: '蚜虫以刺吸式口器吸食植物汁液，繁殖速度极快，在适宜条件下7-10天即可完成一个世代。',
                    treatment: '1. 喷施吡虫啉、啶虫脒等杀虫剂\n2. 使用植物源农药如苦楝油、除虫菊酯\n3. 喷洒肥皂水溶液(40克肥皂溶于1升水)\n4. 释放瓢虫、草蛉等天敌\n5. 喷施10%的酒精溶液直接杀灭',
                    prevention: '1. 定期检查植株，特别是新梢和嫩叶\n2. 保持植株健康，增强抵抗力\n3. 避免过量施用氮肥\n4. 种植驱虫植物如万寿菊、薄荷等\n5. 保护和吸引天敌',
                    notes: '蚜虫不仅直接危害植物，还能传播多种植物病毒病。发现后应及时处理，避免大规模繁殖。'
                },
                '红蜘蛛': {
                    name: '红蜘蛛危害',
                    symptoms: '叶片正面出现细小黄白色斑点，呈现大理石花纹状。叶背可见极小的红色或黄褐色螨类及其网丝。严重时叶片枯黄脱落。',
                    causes: '红蜘蛛(叶螨)在高温干燥环境下繁殖迅速，一个月可完成多代繁殖。主要在叶片背面吸食汁液。',
                    treatment: '1. 喷施阿维菌素、哒螨灵等杀螨剂\n2. 使用硫磺制剂喷洒\n3. 喷施植物油乳剂(如石硫合剂)\n4. 释放捕食螨等天敌\n5. 用强水流冲洗叶片背面',
                    prevention: '1. 增加空气湿度，定期向叶面喷水\n2. 避免环境过于干燥\n3. 定期检查叶片背面\n4. 保持植株通风良好\n5. 适当修剪过密枝叶',
                    notes: '红蜘蛛在高温干燥条件下繁殖极快，一旦发现应立即采取措施。注意药剂轮换使用，避免产生抗性。'
                },
                '白粉虱': {
                    name: '白粉虱危害',
                    symptoms: '叶片背面聚集大量小型白色飞虫，受惊扰时会飞起形成"白云"。叶片黄化，植株生长受阻，并可能出现煤烟病。',
                    causes: '白粉虱以刺吸式口器吸食植物汁液，同时分泌蜜露，繁殖速度快，在温室条件下全年繁殖。',
                    treatment: '1. 喷施吡虫啉、噻虫嗪等杀虫剂\n2. 使用黄色粘虫板诱捕成虫\n3. 喷施植物油乳剂或肥皂水\n4. 生物防治可使用昆虫病原线虫、真菌\n5. 释放捕食性昆虫如瓢虫、草蛉',
                    prevention: '1. 定期检查植株，特别是叶片背面\n2. 保持良好的通风条件\n3. 避免过度施肥，特别是氮肥\n4. 使用防虫网隔离\n5. 清除杂草，减少虫源',
                    notes: '白粉虱是多种植物病毒病的传播媒介，控制白粉虱种群对预防病毒病至关重要。'
                },
                '地下害虫': {
                    name: '地下害虫危害',
                    symptoms: '植株突然萎蔫，生长缓慢，叶片黄化。根部或地下茎有明显的咬痕或孔洞，严重时植株倒伏或死亡。',
                    causes: '由蛴螬、金针虫(线虫)、地老虎等多种地下害虫引起，这些害虫主要危害植物的根系和地下部分。',
                    treatment: '1. 土壤处理剂如辛硫磷、甲基异柳磷等\n2. 生物防治可使用苏云金芽孢杆菌、昆虫病原线虫\n3. 诱杀技术，如设置糖醋液诱捕器\n4. 灌根处理，使用阿维菌素等药剂\n5. 物理防治如翻耕晒土',
                    prevention: '1. 种植前对土壤进行消毒处理\n2. 轮作，避免连作\n3. 合理灌溉，避免土壤过湿\n4. 种植驱虫植物如万寿菊\n5. 使用有机肥时确保充分腐熟',
                    notes: '地下害虫防治难度大，一旦发生大面积危害，治疗效果有限。预防措施尤为重要。'
                },
                '食叶害虫': {
                    name: '食叶害虫危害',
                    symptoms: '叶片边缘或内部有不规则缺刻，有的甚至只剩叶脉。可能观察到毛毛虫、甲虫等昆虫及其粪便。严重时整株叶片被吃光。',
                    causes: '由多种昆虫如毛虫、甲虫、蝗虫等引起，这些昆虫直接取食植物叶片组织。',
                    treatment: '1. 喷施阿维菌素、甲维盐等杀虫剂\n2. 使用苏云金芽孢杆菌等生物农药\n3. 人工捕捉并销毁害虫\n4. 喷施植物源农药如烟碱、除虫菊酯\n5. 释放寄生蜂、食虫鸟类等天敌',
                    prevention: '1. 定期检查植株，特别是叶片背面\n2. 使用防虫网或防虫罩\n3. 种植混合作物，增加生物多样性\n4. 保持田间清洁，清除杂草\n5. 轮作，打破害虫生活周期',
                    notes: '食叶害虫往往在夜间活动，白天隐藏。检查时应注意叶片背面和土壤表面。早期发现和处理可有效控制危害。'
                }
            },
            
            // 通用生理障碍 - 不针对特定植物
            '生理障碍': {
                '营养缺乏': {
                    name: '植物营养缺乏症',
                    symptoms: '不同营养元素缺乏表现不同：缺氮导致整株黄化，缺磷导致叶片紫红色，缺钾导致叶缘焦枯，缺镁导致叶脉间黄化，缺铁导致新叶黄化但叶脉保持绿色。',
                    causes: '土壤中特定营养元素不足，或因土壤pH值不适导致植物无法吸收特定元素。也可能是根系受损影响吸收。',
                    treatment: '1. 根据缺乏症状补充相应元素肥料\n2. 叶面喷施微量元素肥料，快速缓解症状\n3. 调整土壤pH值至适宜范围\n4. 使用有机肥改善土壤整体肥力\n5. 添加腐殖质提高土壤保肥能力',
                    prevention: '1. 定期进行土壤测试，了解营养状况\n2. 按照植物需求科学施肥\n3. 使用缓释肥料，提供持续营养\n4. 合理轮作，避免单一元素过度消耗\n5. 保持适宜的土壤湿度，有利于养分吸收',
                    notes: '不同生长阶段植物对营养元素的需求不同，应根据生长期调整施肥方案。过量施肥可能比缺乏更有害。'
                },
                '水分失衡': {
                    name: '水分失衡障碍',
                    symptoms: '缺水时植株萎蔫，叶片卷曲，叶尖和叶缘干枯。过湿时根系腐烂，叶片黄化，植株生长缓慢，容易发生病害。',
                    causes: '缺水可能是由于浇水不足、蒸发过快或根系受损。过湿则是由于排水不良、浇水过多或盆器没有排水孔。',
                    treatment: '1. 缺水时立即适量浇水，严重时分次少量浇灌\n2. 过湿时停止浇水，改善排水条件\n3. 修剪受损根系和叶片\n4. 调整浇水频率和水量\n5. 使用保水剂或覆盖物调节土壤水分',
                    prevention: '1. 根据植物类型和季节调整浇水方案\n2. 确保盆器或种植区有良好的排水系统\n3. 使用适当的栽培介质，保持透气性\n4. 覆盖地表减少水分蒸发\n5. 安装滴灌或自动灌溉系统确保水分均衡',
                    notes: '大多数植物宁可干燥也不要过湿。检查浇水需求的最佳方法是触摸土壤，而不是按固定时间表浇水。'
                },
                '光照问题': {
                    name: '光照不适症',
                    symptoms: '光照不足时植株徒长，节间拉长，叶片变小且颜色变浅。光照过强时叶片出现灼伤，呈褐色或白色斑块，叶缘卷曲，整体生长受抑。',
                    causes: '室内光线不足，或植物放置位置不当。户外植物可能因季节变化或周围环境改变导致光照条件突变。',
                    treatment: '1. 光照不足时移至更明亮的位置或增加人工光源\n2. 光照过强时提供遮阴或移至散射光处\n3. 逐步调整光照条件，避免突变\n4. 修剪受损叶片，促进新叶生长\n5. 调整浇水频率以适应光照变化',
                    prevention: '1. 了解植物的光照需求，合理摆放\n2. 定期旋转植株，确保各面受光均匀\n3. 使用窗帘或遮阳网调节光照强度\n4. 季节变化时逐步调整植物位置\n5. 考虑使用生长灯补充自然光',
                    notes: '不同植物对光照的需求差异很大，从全日照到深度阴影都有适应的植物。观察叶片颜色和生长状态是判断光照是否适宜的重要指标。'
                },
                '温度障碍': {
                    name: '温度应激反应',
                    symptoms: '低温伤害表现为叶片变紫、变黑或出现水渍状斑块，生长停滞。高温伤害表现为叶片萎蔫、焦边、落花落果，甚至整株死亡。',
                    causes: '温度突变、极端天气、空调直吹、靠近热源或冷源、季节转换时未及时调整环境等。',
                    treatment: '1. 将受冻植物移至温暖处，避免突然升温\n2. 高温时增加通风和遮阴，适当喷水降温\n3. 修剪受损部位，减少植株负担\n4. 调整浇水频率，温度高时增加浇水\n5. 使用保温材料或降温措施',
                    prevention: '1. 了解植物的适宜温度范围\n2. 避免将植物放在温度波动大的位置\n3. 季节变化时逐步调整环境\n4. 使用温室、保温罩或遮阳网调节温度\n5. 选择适合当地气候的植物品种',
                    notes: '温度变化对植物的影响往往滞后，可能在数天后才显现症状。昼夜温差过大也会导致植物生长异常。'
                },
                '土壤问题': {
                    name: '土壤质量障碍',
                    symptoms: '植株生长缓慢，叶片黄化或变色，根系发育不良。盆栽植物可能出现土壤板结、积水或干裂现象。',
                    causes: '土壤质地不适、pH值不合适、有机质含量低、盐分积累、土壤污染或长期使用导致养分耗竭。',
                    treatment: '1. 更换或改良栽培基质\n2. 添加有机质如腐熟堆肥、蚯蚓粪等\n3. 使用土壤调节剂调整pH值\n4. 大量浇水冲洗盐分\n5. 松土改善通气性',
                    prevention: '1. 选择适合植物生长的土壤类型\n2. 定期检测土壤pH值和养分状况\n3. 每1-2年更换盆栽植物的部分土壤\n4. 使用优质水源浇灌，避免盐分积累\n5. 适当添加有机肥，维持土壤活力',
                    notes: '不同植物对土壤的要求差异很大，如兰科植物需要疏松透气的介质，而多肉植物需要排水良好的砂质土。了解植物的原生环境有助于提供合适的土壤条件。'
                }
            }
        };
    }

    /**
     * 根据关键词搜索案例
     */
    searchCases(keywords) {
        const results = [];
        const searchTerms = keywords.toLowerCase().split(/\s+/);

        for (const [plant, diseases] of Object.entries(this.cases)) {
            for (const [diseaseName, diseaseInfo] of Object.entries(diseases)) {
                const searchText = `${plant} ${diseaseName} ${diseaseInfo.symptoms}`.toLowerCase();
                
                // 检查是否包含所有搜索关键词
                const matches = searchTerms.every(term => searchText.includes(term));
                
                if (matches) {
                    results.push({
                        plant: plant,
                        disease: diseaseInfo,
                        relevance: this.calculateRelevance(searchTerms, searchText)
                    });
                }
            }
        }

        // 按相关性排序
        results.sort((a, b) => b.relevance - a.relevance);
        
        return results.slice(0, 5); // 返回前5个最相关的结果
    }

    /**
     * 计算相关性分数
     */
    calculateRelevance(searchTerms, searchText) {
        let score = 0;
        
        for (const term of searchTerms) {
            const count = (searchText.match(new RegExp(term, 'g')) || []).length;
            score += count;
        }
        
        return score;
    }

    /**
     * 获取随机案例（用于演示）
     */
    getRandomCase() {
        const plants = Object.keys(this.cases);
        const randomPlant = plants[Math.floor(Math.random() * plants.length)];
        const diseases = Object.keys(this.cases[randomPlant]);
        const randomDisease = diseases[Math.floor(Math.random() * diseases.length)];
        
        return {
            plant: randomPlant,
            disease: this.cases[randomPlant][randomDisease]
        };
    }

    /**
     * 获取所有植物列表
     */
    getAllPlants() {
        return Object.keys(this.cases);
    }

    /**
     * 获取指定植物的所有病虫害
     */
    getDiseasesByPlant(plant) {
        return this.cases[plant] || {};
    }

    /**
     * 格式化案例为显示格式
     */
    formatCase(caseData) {
        const { plant, disease } = caseData;
        
        return {
            content: `## 诊断结果
${plant}${disease.name}

## 症状分析
${disease.symptoms}

## 病因分析
${disease.causes}

## 防治建议
${disease.treatment}

## 预防措施
${disease.prevention}

## 注意事项
${disease.notes}`,
            usage: {
                prompt_tokens: 150,
                completion_tokens: 300,
                total_tokens: 450
            },
            model: '智能分析',
            timestamp: new Date().toISOString()
        };
    }
}

// 创建全局案例数据库实例
const pestCaseDB = new PestCaseDatabase();