<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤©æ°”æ•°æ®è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .diagnostic-card {
            background: rgba(50, 50, 50, 0.8) !important;
            border: 1px solid rgba(255, 255, 255, 0.4) !important;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6) !important;
            color: white !important;
        }
        .status-ok { color: #28a745; }
        .status-error { color: #dc3545; }
        .status-warning { color: #ffc107; }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .result-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>ğŸ” å¤©æ°”æ•°æ®è¯Šæ–­å·¥å…·</h1>
    
    <div class="diagnostic-card">
        <h3>1. ä»£ç†æœåŠ¡å™¨è¿æ¥æµ‹è¯•</h3>
        <button class="test-button" onclick="testProxyServer()">æµ‹è¯•ä»£ç†æœåŠ¡å™¨</button>
        <div id="proxyResult" class="result-box">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
    </div>

    <div class="diagnostic-card">
        <h3>2. å¤©æ°”APIæ•°æ®æµ‹è¯•</h3>
        <button class="test-button" onclick="testWeatherAPI()">æµ‹è¯•å¤©æ°”API</button>
        <div id="weatherResult" class="result-box">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
    </div>

    <div class="diagnostic-card">
        <h3>3. æœ¬åœ°å­˜å‚¨æ£€æŸ¥</h3>
        <button class="test-button" onclick="checkLocalStorage()">æ£€æŸ¥æœ¬åœ°å­˜å‚¨</button>
        <button class="test-button" onclick="clearLocalStorage()">æ¸…é™¤ç¼“å­˜</button>
        <div id="storageResult" class="result-box">ç‚¹å‡»æŒ‰é’®å¼€å§‹æ£€æŸ¥...</div>
    </div>

    <div class="diagnostic-card">
        <h3>4. ä¸»ç•Œé¢å¤©æ°”å…ƒç´ æ£€æŸ¥</h3>
        <button class="test-button" onclick="checkWeatherElements()">æ£€æŸ¥é¡µé¢å…ƒç´ </button>
        <div id="elementsResult" class="result-box">ç‚¹å‡»æŒ‰é’®å¼€å§‹æ£€æŸ¥...</div>
    </div>

    <div class="diagnostic-card">
        <h3>5. å®æ—¶æ•°æ®æ›´æ–°æµ‹è¯•</h3>
        <button class="test-button" onclick="startRealTimeTest()">å¼€å§‹å®æ—¶æµ‹è¯•</button>
        <button class="test-button" onclick="stopRealTimeTest()">åœæ­¢æµ‹è¯•</button>
        <div id="realtimeResult" class="result-box">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
    </div>

    <script>
        let realtimeInterval = null;

        // æµ‹è¯•ä»£ç†æœåŠ¡å™¨è¿æ¥
        async function testProxyServer() {
            const resultDiv = document.getElementById('proxyResult');
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•ä»£ç†æœåŠ¡å™¨è¿æ¥...';
            
            try {
                const response = await fetch('http://localhost:3000/api/weather', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `<span class="status-ok">âœ… ä»£ç†æœåŠ¡å™¨è¿æ¥æˆåŠŸ</span>\nå“åº”æ•°æ®:\n${JSON.stringify(data, null, 2)}`;
                } else {
                    resultDiv.innerHTML = `<span class="status-error">âŒ ä»£ç†æœåŠ¡å™¨å“åº”é”™è¯¯</span>\nçŠ¶æ€ç : ${response.status}`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="status-error">âŒ ä»£ç†æœåŠ¡å™¨è¿æ¥å¤±è´¥</span>\né”™è¯¯ä¿¡æ¯: ${error.message}\n\nè¯·ç¡®ä¿è¿è¡Œäº†: node proxy-server.js`;
            }
        }

        // æµ‹è¯•å¤©æ°”API
        async function testWeatherAPI() {
            const resultDiv = document.getElementById('weatherResult');
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•å¤©æ°”API...';
            
            try {
                // æ¨¡æ‹Ÿweather-service.jsä¸­çš„è°ƒç”¨
                const response = await fetch('http://localhost:3000/api/weather');
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `<span class="status-ok">âœ… å¤©æ°”APIè°ƒç”¨æˆåŠŸ</span>\næ¸©åº¦: ${data.temperature}Â°C\næ¹¿åº¦: ${data.humidity}%\næ—¶é—´: ${data.timestamp}`;
                } else {
                    resultDiv.innerHTML = `<span class="status-error">âŒ å¤©æ°”APIè°ƒç”¨å¤±è´¥</span>\né”™è¯¯: ${data.error}`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="status-error">âŒ å¤©æ°”APIæµ‹è¯•å¤±è´¥</span>\né”™è¯¯: ${error.message}`;
            }
        }

        // æ£€æŸ¥æœ¬åœ°å­˜å‚¨
        function checkLocalStorage() {
            const resultDiv = document.getElementById('storageResult');
            
            const weatherData = localStorage.getItem('real_weather_data');
            const oldWeatherData = localStorage.getItem('beijing_weather_data');
            
            let result = 'æœ¬åœ°å­˜å‚¨æ£€æŸ¥ç»“æœ:\n\n';
            
            if (weatherData) {
                result += `âœ… æ‰¾åˆ°æ–°çš„å¤©æ°”æ•°æ® (real_weather_data):\n${weatherData}\n\n`;
            } else {
                result += `âŒ æœªæ‰¾åˆ°æ–°çš„å¤©æ°”æ•°æ® (real_weather_data)\n\n`;
            }
            
            if (oldWeatherData) {
                result += `âš ï¸ æ‰¾åˆ°æ—§çš„å¤©æ°”æ•°æ® (beijing_weather_data):\n${oldWeatherData}\n\n`;
            } else {
                result += `âœ… æœªæ‰¾åˆ°æ—§çš„å¤©æ°”æ•°æ®ç¼“å­˜\n\n`;
            }
            
            resultDiv.textContent = result;
        }

        // æ¸…é™¤æœ¬åœ°å­˜å‚¨
        function clearLocalStorage() {
            localStorage.removeItem('real_weather_data');
            localStorage.removeItem('beijing_weather_data');
            document.getElementById('storageResult').innerHTML = '<span class="status-ok">âœ… æœ¬åœ°å­˜å‚¨å·²æ¸…é™¤</span>\nè¯·åˆ·æ–°ä¸»é¡µé¢é‡æ–°åŠ è½½æ•°æ®';
        }

        // æ£€æŸ¥é¡µé¢å…ƒç´ 
        function checkWeatherElements() {
            const resultDiv = document.getElementById('elementsResult');
            
            // æ‰“å¼€ä¸»é¡µé¢æ£€æŸ¥å…ƒç´ 
            const mainWindow = window.open('index.html', '_blank');
            
            setTimeout(() => {
                try {
                    const elements = {
                        '.temperature': mainWindow.document.querySelector('.temperature'),
                        '.weather-desc': mainWindow.document.querySelector('.weather-desc'),
                        '.weather-location': mainWindow.document.querySelector('.weather-location'),
                        '.env-value (æ¹¿åº¦)': mainWindow.document.querySelector('.env-item:nth-child(1) .env-value')
                    };
                    
                    let result = 'é¡µé¢å…ƒç´ æ£€æŸ¥ç»“æœ:\n\n';
                    
                    for (const [selector, element] of Object.entries(elements)) {
                        if (element) {
                            result += `âœ… ${selector}: "${element.textContent}"\n`;
                        } else {
                            result += `âŒ ${selector}: å…ƒç´ æœªæ‰¾åˆ°\n`;
                        }
                    }
                    
                    resultDiv.textContent = result;
                } catch (error) {
                    resultDiv.innerHTML = `<span class="status-error">âŒ æ— æ³•æ£€æŸ¥é¡µé¢å…ƒç´ </span>\né”™è¯¯: ${error.message}\n\nè¯·ç¡®ä¿ä¸»é¡µé¢å·²æ‰“å¼€`;
                }
            }, 2000);
        }

        // å¼€å§‹å®æ—¶æµ‹è¯•
        function startRealTimeTest() {
            const resultDiv = document.getElementById('realtimeResult');
            resultDiv.textContent = 'å¼€å§‹å®æ—¶æ•°æ®ç›‘æ§...\n\n';
            
            let count = 0;
            realtimeInterval = setInterval(async () => {
                count++;
                try {
                    const response = await fetch('http://localhost:3000/api/weather');
                    const data = await response.json();
                    
                    const timestamp = new Date().toLocaleTimeString();
                    const logEntry = `[${timestamp}] ç¬¬${count}æ¬¡: æ¸©åº¦=${data.temperature}Â°C, æ¹¿åº¦=${data.humidity}%\n`;
                    
                    resultDiv.textContent += logEntry;
                    resultDiv.scrollTop = resultDiv.scrollHeight;
                } catch (error) {
                    resultDiv.textContent += `[${new Date().toLocaleTimeString()}] é”™è¯¯: ${error.message}\n`;
                }
            }, 5000);
        }

        // åœæ­¢å®æ—¶æµ‹è¯•
        function stopRealTimeTest() {
            if (realtimeInterval) {
                clearInterval(realtimeInterval);
                realtimeInterval = null;
                document.getElementById('realtimeResult').textContent += '\nå®æ—¶æµ‹è¯•å·²åœæ­¢ã€‚';
            }
        }
    </script>
</body>
</html>